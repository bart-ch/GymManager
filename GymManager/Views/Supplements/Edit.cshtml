
@{
    ViewBag.Title = "Edit Supplement";
}

<h2>@ViewBag.Title</h2>

@Html.Partial("_SupplementForm")

@section Scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/scripts/GymManager/gm-pupulate-select-with-ajax-get.js")

    <script>
        $(document).ready(function () {
            getResourcesFromAPIAndInsertInSelect("#supplementTypeId", "Supplement Type", "supplementTypes");
            getResourcesFromAPIAndInsertInSelect("#flavorId", "Flavor", "flavors");

            var url = $(location).attr('href');
            var id = url.substring(url.lastIndexOf('/') + 1);
            if (id > 0) {
                $.ajax({
                    type: "GET",
                    url: "/api/supplements/" + id,
                })
                    .done(function (supplement) {
                        $("#brand").val(supplement.brand);
                        $("#supplementTypeId").val(supplement.supplementType.id);
                        $("#flavorId").val(supplement.flavor.id);
                        $("#initialAmount").val(supplement.initialAmount);
                        $("#consumedAmount").val(supplement.consumedAmount);
                        var date = new Date(supplement.deliveryDate);
                        var dateString = date.getFullYear() + '-'
                            + ('0' + (date.getMonth() + 1)).slice(-2) + '-'
                            + ('0' + date.getDate()).slice(-2);
                        $("#deliveryDate").val(dateString);

                    })
                    .fail(function () {
                        window.location.pathname = '/Supplements'
                    });
            }

            $("#equipmentForm").validate({
                errorPlacement: function ($error, $element) {
                    var name = $element.attr("name");
                    $("#error" + name).append($error);
                },
                rules: {
                    brand: {
                        maxlength: 30
                    },
                    model: {
                        maxlength: 30
                    },
                    serialNumber: {
                        maxlength: 30
                    }
                },
                submitHandler: function () {
                    var formData = $('#equipmentForm').serializeArray().reduce(function (obj, item) {
                        obj[item.name] = item.value;
                        return obj;
                    }, {});
                    $.ajax({
                        url: "/api/equipment/" + id,
                        method: "PUT",
                        data: formData
                    })
                        .done(function () {
                            toastr.success("Equipment successfully updated.");
                        })
                        .fail(function () {
                            toastr.error("Unexpected error.");
                        });

                    return false;
                }
            });
        })

    </script>
}

